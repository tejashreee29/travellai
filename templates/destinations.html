<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destinations - TravelPlan</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <header>
        <h1>âœˆï¸ TravelPlan</h1>
        <div>
            <span>Welcome, <strong>{{ user }}</strong></span>
            <a href="/dashboard">Dashboard</a> |
            <a href="/logout">Sign Out</a>
        </div>
    </header>

    <div class="destinations-container">
        {% if error %}
        <div class="card" style="margin-top: 2rem; background: #ffebee; border-left: 4px solid #f44336; padding: 1rem;">
            <p style="color: #c62828; margin: 0;"><strong>Error:</strong> {{ error }}</p>
        </div>
        {% endif %}

        <div class="card" style="margin-top: 2rem;">
            <h2 style="margin-bottom: 1.5rem;">ğŸŒ AI-Powered Destination Recommendations</h2>
            <form method="post" class="search-form" id="searchForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div>
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 600;">Travel
                        Type</label>
                    <select name="travel_type" required id="travel_type_select"
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;">
                        <option value="beaches" {% if travel_type=="beaches" %}selected{% endif %}>ğŸ–ï¸ Beaches</option>
                        <option value="culture" {% if travel_type=="culture" %}selected{% endif %}>ğŸ›ï¸ Culture &
                            Heritage</option>
                        <option value="adventure" {% if travel_type=="adventure" %}selected{% endif %}>â›°ï¸ Adventure
                        </option>
                        <option value="nature" {% if travel_type=="nature" %}selected{% endif %}>ğŸŒ² Nature</option>
                        <option value="nightlife" {% if travel_type=="nightlife" %}selected{% endif %}>ğŸŒƒ Nightlife
                        </option>
                        <option value="cuisine" {% if travel_type=="cuisine" %}selected{% endif %}>ğŸ½ï¸ Cuisine</option>
                        <option value="wellness" {% if travel_type=="wellness" %}selected{% endif %}>ğŸ§˜ Wellness
                        </option>
                        <option value="urban" {% if travel_type=="urban" %}selected{% endif %}>ğŸ™ï¸ Urban Exploration
                        </option>
                        <option value="mood" {% if travel_type=="mood" %}selected{% endif %}>ğŸ˜Š Mood-Based</option>
                    </select>
                </div>

                <div>
                    <label
                        style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 600;">Budget
                        Level</label>
                    <select name="budget" required id="budget_select"
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;">
                        <option value="low" {% if budget=="low" %}selected{% endif %}>ğŸ’° Low Budget</option>
                        <option value="medium" {% if budget=="medium" %}selected{% endif %}>ğŸ’°ğŸ’° Medium Budget</option>
                        <option value="high" {% if budget=="high" %}selected{% endif %}>ğŸ’°ğŸ’°ğŸ’° High Budget</option>
                    </select>
                </div>

                <button type="submit" style="grid-column: 1 / -1;">Search Destinations</button>
            </form>
        </div>

        {% if results is not none and results|length > 0 %}
        <div style="margin-top: 2rem;">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">AI-Recommended Destinations</h2>
            <div class="results-grid">
                {% for r in results.itertuples() %}
                <div class="destination-card">
                    <h3>{{ r.city }}, {{ r.country }}</h3>
                    <div class="score">AI Score: {{ "%.2f"|format(r.final_score) }}</div>

                    {% if r.ideal_time %}
                    <div
                        style="margin-top: 0.75rem; padding: 0.75rem; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2193b0;">
                        <p style="color: var(--primary-color); margin: 0; font-size: 0.9rem; font-weight: 600;">
                            ğŸ“… {{ r.ideal_time }}
                        </p>
                    </div>
                    {% endif %}

                    {% if r.description %}
                    <div
                        style="margin-top: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary-color);">
                        <p style="color: var(--text-dark); line-height: 1.6; margin: 0; font-size: 0.95rem;">
                            <strong>About this destination:</strong><br>
                            {{ r.description }}
                        </p>
                    </div>
                    {% endif %}

                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <a href="/itinerary?city={{ r.city | urlencode }}" class="btn"
                            style="flex: 1; text-align: center; text-decoration: none; padding: 0.75rem 1rem; background: var(--primary-color); color: white; border-radius: 8px; font-weight: 600; transition: all 0.3s;">
                            ğŸ—“ï¸ Create Itinerary
                        </a>

                        <button class="save-dest-btn" data-city="{{ r.city }}" data-country="{{ r.country }}"
                            data-score="{{ r.final_score }}" data-travel-type="{{ travel_type }}"
                            data-description="{{ r.description if r.description else '' }}"
                            data-ideal-time="{{ r.ideal_time if r.ideal_time else '' }}"
                            style="flex: 1; padding: 0.75rem 1rem; background: #ffc107; color: var(--text-dark); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            â­ Save
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <div id="chatbot"></div>

    <script>
        // Save destination functionality
        document.addEventListener('DOMContentLoaded', function () {
            const saveButtons = document.querySelectorAll('.save-dest-btn');
            saveButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const city = this.getAttribute('data-city');
                    const country = this.getAttribute('data-country');
                    const score = parseFloat(this.getAttribute('data-score'));
                    const travelType = this.getAttribute('data-travel-type') || document.querySelector('#travel_type_select')?.value || '';
                    const description = this.getAttribute('data-description') || '';
                    const idealTime = this.getAttribute('data-ideal-time') || '';

                    fetch('/save_destination', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            city: city,
                            country: country,
                            score: score,
                            travel_type: travelType,
                            description: description,
                            ideal_time: idealTime
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                this.textContent = 'âœ“ Saved!';
                                this.style.background = '#4caf50';
                                this.disabled = true;
                            } else {
                                alert('Error saving destination');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error saving destination');
                        });
                });
            });
        });
    </script>
    <script src="/static/chatbot.js"></script>
</body>

</html>